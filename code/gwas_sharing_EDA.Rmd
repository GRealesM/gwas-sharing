---
title: "GWAS sharing EDA"
author: "Guillermo Reales"
date: "2022-05-31"
output: html_document
---

# Background

We want to motivate researchers to share more GWAS summary statistics with the community, and we hypothesise that sharing can result in more citations.

This notebook contains part of the EDA within this project

# Prepare data

```{r}
## Load packages
library(data.table)
library(magrittr)
library(ggplot2)
library(iCiteR)

```
```{r echo = FALSE}
pubs <- fread("../data/Publications_20220525.tsv")
citinfo <- fread("../data/Citation_info_20220525.tsv")
m <- fread("../data/Summary_info_20220530.tsv", na.strings = "NA")
```


```{r eval=FALSE}
## List of publications and available summary statistics downloaded on 2022-05-24
pubs <- fread("../data/gwas-catalog-v1.0.3-studies-r2022-05-17.tsv", sep="\t") # Published studies
ss <- fread("../data/list_gwas_summary_statistics_24_May_2022.csv")  # Studies with summary statistics
SCR <- fread("../data/scimagojr_2021.csv")
NLM <- fread("../data/NLM_journals.tsv") # NLM catalog with journal names, ISSN, and abbreviations

## Replace key column names by something more useful
setnames(pubs, c("FIRST AUTHOR", "PUBMED ID", "STUDY ACCESSION", "ASSOCIATION COUNT"), c("First_Author", "PMID", "accession", "association_count")) 
setnames(ss, c("PubMed ID", "Study accession"), c("PMID", "accession"))

## Label studies with summary statistics and check how many of them in each study
pubs[, Public_ss := ifelse(PMID %in% ss$PMID, "Y","N")]
ds_num <- ss[, .(ds_count = .N), by=PMID] # Number of published summary statistics datasets
pubs <- merge(pubs, ds_num, by="PMID", all.x=TRUE)
pubs[is.na(ds_count), ds_count:=0]

## Update changed PMID. This PMID was removed because it was duplicated in PubMed, so we update it to the current ID. It didn't have summary statistics.  
pubs[PMID == 24513584, PMID:=24516880]

## Subset columns to keep key information per paper
m <- unique(pubs[, .(PMID, Public_ss, ds_count)])

# Get citation info
citinfo <- lapply(0:5, function(x){
	start_idx = (x * 1000) + 1
	if(x == 0) start_idx = 1
	end_idx = start_idx + 999
	if(end_idx > nrow(m)) end_idx = nrow(m)
	
	pmids <- m$PMID[start_idx:end_idx]
	message("Getting metrics for papers ", start_idx, " to ", end_idx) 
	papers <- get_metrics(pmids)
})
citinfo <- rbindlist(citinfo)

# Extract key data for analysis and merge both datasets
cit <- citinfo[, .(pmid, journal, year, is_research_article, relative_citation_ratio, nih_percentile, citation_count, citations_per_year, expected_citations_per_year, field_citation_rate)] 
m <- merge(m, cit, by.x="PMID", by.y="pmid")

# Match Journal Abbreviations from GWAS catalog with journal names 

jab <- unique(m$journal) # unique abbreviations
NLM.g <- NLM[ MedAbbr %in% jab] 
# There are some duplications, let's get rid of them
dup.nlmg <- NLM.g[duplicated(MedAbbr), MedAbbr]
NLM.g[MedAbbr %in% dup.nlmg]
NLM.g <- NLM.g[!NlmId %in% c("7803060", "0074126")] # Checked duplicated in SCR and the latter two didn't have an entry by ISSN in SCR, so we'll remove them

# Now we need to match SCR info with NLM.g. We'll do it by matching ISSN. 
# SCR file has two types of ISSN (Online and Print) in one comma-separated string, and the order is not constant (????) so we'll try to separate and match
NLM.g[, Issn.print:=gsub("-", "", `ISSN (Print)`)][, Issn.online:=gsub("-", "", `ISSN (Online)`)] # SCR Issn are missing the hyphen, so let's remove it
mSCR <- copy(SCR)
mSCR[, c("V1", "V2", "V3", "V4"):=tstrsplit(Issn, ", ")]
guide.SCR <- melt(mSCR, id.vars = "Title", measure.vars =  c("V1", "V2", "V3", "V4"))
guide.SCR <- na.omit(guide.SCR)
guide.NLM <- melt(NLM.g, id.vars = "MedAbbr", measure.vars = c("Issn.print", "Issn.online"))
m.guides <- merge(guide.SCR, guide.NLM, by="value")
m.guides <- unique(m.guides[, .(Title, MedAbbr)])
setnames(m.guides, "Title", "SCR.title")

m <- merge(m, m.guides, by.x = "journal", by.y = "MedAbbr", all.x = TRUE) # Merge with guides to get the journal title
sSCR <- SCR[ Title %in% m$SCR.title, .(Title, SJR, `SJR Best Quartile`, `H index`, Publisher)][, SJR:=as.numeric(gsub(",", ".", SJR))] # Select columns to use. Also replace comma for numeric SJR
m <- merge(m, sSCR, by.x = "SCR.title", by.y="Title", all.x = TRUE) 
setnames(m, c("H index", "SJR Best Quartile"), c("H_index", "SJR_Best_Quartile"))


# Store data
fwrite(pubs, "../data/Publications_20220525.tsv", sep="\t")
fwrite(citinfo, "../data/Citation_info_20220525.tsv", sep="\t")
fwrite(m, "../data/Summary_info_20220530.tsv", sep="\t", na = NA)
```
Let's take a look at the datasets


# Data visualisation

We have several initial questions about the data

## 1 - What's the proportion of studies with shared or not shared data?

```{r}
table(m$Public_ss) / nrow(m)
ggplot(m, aes(x=Public_ss))+ geom_bar(stat="count") + xlab("Summary statistics available?") 
```

Most studies don't have shared summary statistics in GWAS catalog. Approximately 1/10 studies share summary statistics.

## 2 - How did sharing change over time?

```{r}
ggplot(m, aes(x=year, fill=Public_ss))+ geom_bar(position = "dodge", stat="count") + xlab("Summary statistics available?") 
```

It looks like sharing is gaining momentum, but still represent the minority of all reported studies.

## 3 - Do sharing result in higher citations overall?

```{r}
ggplot(m, aes(x = Public_ss, y=citations_per_year)) + geom_boxplot() + xlab("Summary statistics available?") + ylab("Citations per year")
```

## 4 - Does this change over time?

```{r fig.height= 6, fig.width=10}
ggplot(m, aes(x=as.factor(year), y=citations_per_year, fill=Public_ss))+ geom_boxplot() + xlab("Year") + ylab("Citations per year")
```

## 5 - Are there differences between journals?

We know that some journals are more cited than others and some publish more GWAS than others. Let's take a look at the journal profile

```{r}
m[, .N, by=journal][order(-N)]
ggplot(m[, .N, by=journal], aes(x=N)) + geom_histogram(bins = 60) + xlab("Studies per journal") + ylab("Number of Journals")
```

We see a huge imbalance in journals and papers, with the top 10 journals containing \~40% of the studies, while most journals have very few studies (\~24% of journals have less than 10 studies).

*Nature Genetics* is by far the journal with most GWAS in GWAS catalog.

```{r}
top10 <- m[, .N, by=journal][order(-N)][1:10, journal]
mj <- m[journal %in% top10 ]
ggplot(mj, aes(x=journal, y=citations_per_year, fill=Public_ss))+ geom_boxplot() + xlab("Journal (Top 10 most papers in GWAS catalog)") + ylab("Citations per year") + theme(axis.text.x = element_text(angle = -45, hjust=0))
```

# 6 - What about Impact Factor? 

We'd assume that IF will result with more citations, but is it associated with more sharing? I downloaded 2021 data from Scimago Journal and Country Rank (https://www.scimagojr.com/) to get some bibliometrics on the journals.  **Note:** 27 Journals didn't have SJR, either because they're too new or because they've been discontinued

```{r}
unique(m[, .(SJR, journal)]) %>% .[is.na(SJR)]
ggplot(m, aes(x = Public_ss, y = SJR)) + geom_boxplot()+ ylab("SJR Impact factor") 
ggplot(m, aes(x = H_index, y = citations_per_year, colour = Public_ss)) + geom_point(alpha = 0.5)+ xlab("H Index") + ylab("Citations per year") 
```

